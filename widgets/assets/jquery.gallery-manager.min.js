(function(b){var c={csrfToken:b("meta[name=csrf-token]").attr("content"),csrfTokenName:b("meta[name=csrf-param]").attr("content"),nameLabel:"Name",descriptionLabel:"Description",hasName:true,hasDesc:true,uploadUrl:"",deleteUrl:"",updateUrl:"",arrangeUrl:"",photos:[]};function a(e,j){var t=b.extend({},c,j);var r=t.csrfToken?"&"+t.csrfTokenName+"="+t.csrfToken:"";var E={};var F=b(e);if(!t.hasName){if(!t.hasDesc){F.addClass("no-name-no-desc");b(".edit-selected",F).hide()}else{F.addClass("no-name")}}else{if(!t.hasDesc){F.addClass("no-desc")}}var D=b(".sorter",F);var w=b(".images",D);var z=b(".editor-modal",F);var f=b(".progress-overlay",F);var g=b(".upload-progress",f);var y=b(".form",z);function q(i){return String(i).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function u(I,H,i,G){var l='<div class="photo-editor row"><div class="col-xs-4"><img src="'+q(H)+'"  style="max-width:100%;"></div><div class="col-xs-8">'+(t.hasName?'<div class="form-group"><label class="control-label" for="photo_name_'+I+'">'+t.nameLabel+':</label><input class="form-control" type="text" name="photo['+I+'][name]" class="input-xlarge" value="'+q(i)+'" id="photo_name_'+I+'"/></div>':"")+(t.hasDesc?'<div class="form-group"><label class="control-label" for="photo_description_'+I+'">'+t.descriptionLabel+':</label><textarea class="form-control" name="photo['+I+'][description]" rows="3" cols="40" class="input-xlarge" id="photo_description_'+I+'">'+q(G)+"</textarea></div>":"")+"</div></div>";return b(l)}var o='<div class="photo col-md-3 col-sm-6 col-xs-12"><div class="image-preview"><img src=""/></div><div class="caption">';if(t.hasName){o+="<h5></h5>"}if(t.hasDesc){o+="<p></p>"}o+='</div><div class="wrap-actions"><div class="actions pull-right btn-group">';if(t.hasName||t.hasDesc){o+='<span class="edit-photo btn btn-primary btn-xs"><i class="glyphicon glyphicon-pencil glyphicon-white"></i></span>'}o+='<span class="delete-photo btn btn-danger btn-xs"><i class="glyphicon glyphicon-remove glyphicon-white"></i></span></div><div class="pull-left"><input type="checkbox" class="photo-select"/></div></div></div>';function d(J,I,l,G,H){var i=b(o);E[J]=i;i.data("id",J);i.data("rank",H);b("img",i).attr("src",I);if(t.hasName){b(".caption h5",i).text(l)}if(t.hasDesc){b(".caption p",i).text(G)}w.append(i);return i}function n(H){var M=H.length;var L=y.empty();for(var N=0;N<M;N++){var K=H[N];var I=E[K],G=b("img",I).attr("src"),J=b(".caption h5",I).text(),O=b(".caption p",I).text();L.append(u(K,G,J,O))}if(M>0){z.modal("show")}}function C(i){b.ajax({type:"POST",url:t.deleteUrl,data:"id[]="+i.join("&id[]=")+r,success:function(I){if(I=="OK"){for(var H=0,G=i.length;H<G;H++){E[i[H]].remove();delete E[i[H]]}}else{alert(I)}}})}function m(l){l.preventDefault();var i=b(this).closest(".photo");var G=i.data("id");C([G]);return false}function p(l){l.preventDefault();var i=b(this).closest(".photo");var G=i.data("id");n([G]);return false}function s(){var i=b(".photo.selected",D).length;b(".select_all",F).prop("checked",b(".photo",D).length==i);if(i==0){b(".edit-selected, .remove-selected",F).addClass("disabled")}else{b(".edit-selected, .remove-selected",F).removeClass("disabled")}}function B(){var i=b(this);if(i.is(":checked")){i.closest(".photo").addClass("selected")}else{i.closest(".photo").removeClass("selected")}s()}w.on("click",".photo .delete-photo",m).on("click",".photo .edit-photo",p).on("click",".photo .photo-select",B);b(".images",D).sortable({tolerance:"pointer"}).disableSelection().bind("sortstop",function(){var i=[];b(".photo",D).each(function(){var l=b(this);i.push("order["+l.data("id")+"]="+l.data("rank"))});b.ajax({type:"POST",url:t.arrangeUrl,data:i.join("&")+r,dataType:"json"}).done(function(l){for(var G in l[G]){E[G].data("rank",l[G])}})});if(window.FormData!==undefined){var h=b(".afile",F).attr("name");var k=function(K){if(K.length==0){return}f.show();g.css("width","5%");var G=K.length;var l=0;var J=[];for(var I=0;I<G;I++){var H=new FormData();H.append(h,K[I]);if(t.csrfToken){H.append(t.csrfTokenName,t.csrfToken)}var L=new XMLHttpRequest();L.open("POST",t.uploadUrl,true);L.onload=function(){l++;if(this.status==200){var i=JSON.parse(this.response);d(i.id,i.preview,i.name,i.description,i.rank);J.push(i.id)}else{}g.css("width",""+(5+95*l/G)+"%");if(l===G){g.css("width","100%");f.hide();if(t.hasName||t.hasDesc){n(J)}}};L.send(H)}};(function(){var H=F[0];var I=false;var G=false;setInterval(function(){if(I!=G){if(I){H.classList.add("over")}else{H.classList.remove("over")}G=I}},30);function K(L){L.preventDefault();I=true;return false}function i(){I=false;return false}function J(M){M.preventDefault();M.stopPropagation();var L=M.dataTransfer.files;k(L);I=false;return false}function l(){I=false}H.addEventListener("dragover",K,false);H.addEventListener("dragleave",i,false);H.addEventListener("drop",J,false);H.addEventListener("dragend",l,false)})();b(".afile",F).attr("multiple","true").on("change",function(i){i.preventDefault();k(this.files)})}else{b(".afile",F).on("change",function(G){G.preventDefault();var i=[];f.show();g.css("width","5%");var l={};if(t.csrfToken){l[t.csrfTokenName]=t.csrfToken}b.ajax({type:"POST",url:t.uploadUrl,data:l,files:b(this),iframe:true,processData:false,dataType:"json"}).done(function(H){d(H.id,H.preview,H.name,H.description,H.rank);i.push(H.id);g.css("width","100%");f.hide();if(t.hasName||t.hasDesc){n(i)}})})}b(".save-changes",z).click(function(i){i.preventDefault();b.post(t.updateUrl,b("input, textarea",y).serialize()+r,function(I){var H=I.length;for(var G=0;G<H;G++){var J=I[G];var l=E[J.id];b("img",l).attr("src",J.src);if(t.hasName){b(".caption h5",l).text(J.name)}if(t.hasDesc){b(".caption p",l).text(J.description)}}z.modal("hide");b(".photo.selected",D).each(function(){b(".photo-select",this).prop("checked",false)}).removeClass("selected");b(".select_all",F).prop("checked",false);s()},"json")});b(".edit-selected",F).click(function(l){l.preventDefault();var i=[];b(".photo.selected",D).each(function(){i.push(b(this).data("id"))});n(i);return false});b(".remove-selected",F).click(function(l){l.preventDefault();var i=[];b(".photo.selected",D).each(function(){i.push(b(this).data("id"))});C(i)});b(".select_all",F).change(function(){if(b(this).prop("checked")){b(".photo",D).each(function(){b(".photo-select",this).prop("checked",true)}).addClass("selected")}else{b(".photo.selected",D).each(function(){b(".photo-select",this).prop("checked",false)}).removeClass("selected")}s()});for(var A=0,x=t.photos.length;A<x;A++){var v=t.photos[A];d(v.id,v.preview,v.name,v.description,v.rank)}}b.fn.galleryManager=function(d){if(this.length){this.each(function(){a(this,d)})}}})(jQuery);